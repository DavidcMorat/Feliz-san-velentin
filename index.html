<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ConstruAgg - Gestión Profesional</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: #f5f7fa; color: #333; min-height: 100vh; }
        
        /* Loading Screen */
        #loadingScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary); display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; z-index: 9999; transition: opacity 0.3s ease-out; }
        #loadingScreen.hide { opacity: 0; pointer-events: none; }
        .spinner { width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        /* Layout */
        #authContainer { display: none; width: 100%; max-width: 400px; margin: 100px auto; padding: 40px; background: white; border-radius: 20px; box-shadow: 0 15px 30px rgba(0,0,0,0.1); }
        #authContainer.active { display: block; }
        #dashboardContainer { display: none; min-height: 100vh; }
        #dashboardContainer.active { display: flex; }
        
        /* Sidebar */
        .sidebar { width: 250px; background: var(--primary); color: white; padding: 20px 0; transition: all 0.3s; display: flex; flex-direction: column; position: fixed; height: 100vh; z-index: 100; }
        .logo { text-align: center; padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
        .logo h2 { font-size: 1.5rem; } .logo span { color: var(--secondary); }
        .nav-links { list-style: none; flex: 1; }
        .nav-links a { color: white; text-decoration: none; padding: 15px 25px; display: flex; align-items: center; transition: all 0.3s; }
        .nav-links a:hover, .nav-links a.active { background: rgba(255,255,255,0.1); border-left: 4px solid var(--secondary); }
        .nav-links i { margin-right: 12px; width: 20px; text-align: center; }
        
        /* Main Content */
        .main-content { flex: 1; margin-left: 250px; padding: 20px; overflow-y: auto; height: 100vh; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .user-info { display: flex; align-items: center; gap: 10px; }
        .user-avatar { width: 40px; height: 40px; background: var(--secondary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; }
        
        /* Cards */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: white; border-radius: 10px; padding: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: transform 0.3s; }
        .card:hover { transform: translateY(-5px); }
        .card-title { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; color: var(--primary); }
        .card-value { font-size: 2rem; font-weight: bold; color: var(--primary); margin-bottom: 10px; }
        
        /* Tables & UI */
        .table-container { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); overflow-x: auto; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { text-align: left; padding: 15px; border-bottom: 2px solid #eee; color: var(--primary); background: #f8f9fa; }
        td { padding: 15px; border-bottom: 1px solid #eee; }
        .status { padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; }
        .status.pendiente { background: #fff3cd; color: #856404; }
        .status.cancelado { background: #f8d7da; color: #721c24; }
        .status.pagado { background: #d4edda; color: #155724; }
        
        .btn { padding: 8px 16px; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; transition: all 0.3s; margin-right: 5px; }
        .btn-primary { background: var(--secondary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-excel { background: #217346; color: white; } /* Color Excel */
        
        /* Inputs */
        .form-control { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 15px; }
        .alert { padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none; }
        .alert-success { background: #d4edda; color: #155724; }
        .alert-danger { background: #f8d7da; color: #721c24; }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal-overlay.active { display: flex; }
        .modal-container { background: white; width: 90%; max-width: 500px; padding: 30px; border-radius: 10px; max-height: 90vh; overflow-y: auto; }

        /* Excel Controls */
        .excel-controls { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; background: #f1f8e9; padding: 10px; border-radius: 8px; border: 1px solid #c8e6c9; }

        @media (max-width: 992px) {
            .sidebar { left: -250px; }
            .sidebar.active { left: 0; }
            .main-content { margin-left: 0; }
            .menu-toggle { display: block; }
        }
    </style>
</head>
<body>
    <div id="loadingScreen">
        <div class="spinner"></div>
        <h2>ConstruAgg</h2>
        <p>Cargando sistema...</p>
    </div>

    <div id="authContainer">
        <div style="text-align: center;">
            <div class="logo"><i class="fas fa-cubes" style="font-size: 3rem; color: var(--secondary);"></i></div>
            <h2>Constru<span>Agg</span></h2>
            <div class="alert" id="authAlert"></div>
            <input type="email" class="form-control" id="loginEmail" placeholder="Correo electrónico">
            <input type="password" class="form-control" id="loginPassword" placeholder="Contraseña">
            <button class="btn btn-primary" style="width: 100%;" id="btnLogin">Iniciar Sesión</button>
        </div>
    </div>

    <div id="dashboardContainer">
        <div class="sidebar" id="sidebar">
            <div class="logo"><h2>Constru<span>Agg</span></h2></div>
            <ul class="nav-links">
                <li><a href="#" class="active" data-section="dashboard"><i class="fas fa-chart-line"></i> Dashboard</a></li>
                <li><a href="#" data-section="ventas"><i class="fas fa-truck-loading"></i> Ventas (Obras)</a></li>
                <li><a href="#" data-section="stock"><i class="fas fa-boxes"></i> Almacén</a></li>
                <li><a href="#" data-section="personal"><i class="fas fa-users"></i> Personal</a></li>
            </ul>
        </div>

        <div class="main-content">
            <div class="header">
                <button class="btn btn-primary" id="menuToggle" style="display: none;"><i class="fas fa-bars"></i></button>
                <h1 id="pageTitle">Dashboard General</h1>
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <button class="btn btn-danger" id="btnLogout">Salir</button>
                </div>
            </div>

            <div id="dashboard" class="content-section active">
                <div class="dashboard-grid">
                    <div class="card">
                        <div class="card-title"><h3>Ventas Totales</h3><i class="fas fa-coins"></i></div>
                        <div class="card-value" id="dashTotalVentas">S/. 0.00</div>
                        <small style="color: var(--success);">Ingresos acumulados</small>
                    </div>
                    <div class="card">
                        <div class="card-title"><h3>Total M3</h3><i class="fas fa-mountain"></i></div>
                        <div class="card-value" id="dashTotalM3">0 m³</div>
                        <small>Material despachado</small>
                    </div>
                    <div class="card">
                        <div class="card-title"><h3>Viajes</h3><i class="fas fa-truck"></i></div>
                        <div class="card-value" id="dashViajes">0</div>
                        <small>Total despachos</small>
                    </div>
                </div>
            </div>

            <div id="ventas" class="content-section" style="display:none;">
                <div class="table-container">
                    <h3>Registro de Ventas y Agregados</h3>
                    
                    <div class="excel-controls">
                        <label class="btn btn-excel" style="cursor: pointer;">
                            <i class="fas fa-file-import"></i> Importar Excel
                            <input type="file" id="importVentas" accept=".xlsx" style="display: none;">
                        </label>
                        <button class="btn btn-excel" onclick="exportarExcelVentas()"><i class="fas fa-file-export"></i> Exportar Profesional</button>
                        <button class="btn btn-primary" onclick="openModal('venta')"><i class="fas fa-plus"></i> Nuevo Registro</button>
                    </div>

                    <table id="tablaVentas">
                        <thead>
                            <tr>
                                <th>FECHA</th>
                                <th>OBRA / CLIENTE</th>
                                <th>MATERIAL</th>
                                <th>M3</th>
                                <th>PRECIO (S/.)</th>
                                <th>TRANSPORTE</th>
                                <th>TOTAL (S/.)</th>
                                <th>ESTADO</th>
                                <th>ACCIONES</th>
                            </tr>
                        </thead>
                        <tbody id="bodyVentas"></tbody>
                    </table>
                </div>
            </div>

            <div id="stock" class="content-section" style="display:none;">
                <div class="table-container">
                    <h3>Control de Almacén</h3>
                    <div class="excel-controls">
                        <button class="btn btn-primary" onclick="openModal('stock')"><i class="fas fa-plus"></i> Agregar Material</button>
                    </div>
                    <table id="tablaStock">
                        <thead><tr><th>MATERIAL</th><th>STOCK ACTUAL (M3)</th><th>ESTADO</th><th>ACCIONES</th></tr></thead>
                        <tbody id="bodyStock"></tbody>
                    </table>
                </div>
            </div>

            <div id="personal" class="content-section" style="display:none;">
                 <div class="table-container">
                    <h3>Gestión de Personal</h3>
                    <div class="excel-controls">
                         <label class="btn btn-excel" style="cursor: pointer;">
                            <i class="fas fa-file-import"></i> Cargar desde Excel
                            <input type="file" id="importPersonal" accept=".xlsx" style="display: none;">
                        </label>
                        <button class="btn btn-primary" onclick="openModal('personal')"><i class="fas fa-plus"></i> Nuevo</button>
                    </div>
                    <table id="tablaPersonal">
                        <thead><tr><th>NOMBRE</th><th>CARGO</th><th>TELÉFONO</th><th>ACCIONES</th></tr></thead>
                        <tbody id="bodyPersonal"></tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <div class="modal-overlay" id="genericModal">
        <div class="modal-container">
            <h3 id="modalTitle" style="margin-bottom: 20px;">Nuevo Registro</h3>
            <form id="dynamicForm"></form>
            <div style="text-align: right; margin-top: 20px;">
                <button class="btn btn-danger" onclick="closeModal()">Cancelar</button>
                <button class="btn btn-success" id="btnSave">Guardar</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, updateDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDGgdMMipFBWREpTVWL2oC2LZMO6ZvBsic",
            authDomain: "frandey-7fe51.firebaseapp.com",
            projectId: "frandey-7fe51",
            storageBucket: "frandey-7fe51.firebasestorage.app",
            messagingSenderId: "992246403278",
            appId: "1:992246403278:web:c28c8e6bfc67c53d7b009f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Variables Globales
        let currentModalType = '';
        let currentEditId = null;

        // --- AUTH ---
        onAuthStateChanged(auth, (user) => {
            document.getElementById('loadingScreen').classList.add('hide');
            if (user) {
                document.getElementById('authContainer').classList.remove('active');
                document.getElementById('dashboardContainer').classList.add('active');
                document.getElementById('userAvatar').innerText = user.email.charAt(0).toUpperCase();
                loadAllData();
            } else {
                document.getElementById('authContainer').classList.add('active');
                document.getElementById('dashboardContainer').classList.remove('active');
            }
        });

        document.getElementById('btnLogin').onclick = async () => {
            try {
                await signInWithEmailAndPassword(auth, 
                    document.getElementById('loginEmail').value, 
                    document.getElementById('loginPassword').value
                );
            } catch (e) {
                alert("Error: " + e.message);
            }
        };
        document.getElementById('btnLogout').onclick = () => signOut(auth);

        // --- NAVEGACIÓN ---
        document.querySelectorAll('.nav-links a').forEach(link => {
            link.onclick = (e) => {
                e.preventDefault();
                document.querySelectorAll('.nav-links a').forEach(l => l.classList.remove('active'));
                link.classList.add('active');
                document.querySelectorAll('.content-section').forEach(s => s.style.display = 'none');
                document.getElementById(link.dataset.section).style.display = 'block';
                document.getElementById('pageTitle').innerText = link.innerText;
            };
        });

        // --- CARGAR DATOS ---
        async function loadAllData() {
            loadVentas();
            loadStock();
            loadPersonal();
        }

        // 1. CARGAR VENTAS (Con corrección de números)
        async function loadVentas() {
            const body = document.getElementById('bodyVentas');
            body.innerHTML = '<tr><td colspan="9" style="text-align:center">Cargando datos...</td></tr>';
            
            try {
                const q = query(collection(db, "Ventas"), orderBy("fecha", "desc")); // Ordenar por fecha
                const snap = await getDocs(q);
                
                let totalSoles = 0;
                let totalM3 = 0;
                let totalViajes = 0;
                
                body.innerHTML = '';
                
                snap.forEach(doc => {
                    const d = doc.data();
                    
                    // Asegurar números para estadísticas
                    const precioTotal = parseFloat(d.total) || 0;
                    const m3 = parseFloat(d.m3) || 0;
                    
                    totalSoles += precioTotal;
                    totalM3 += m3;
                    totalViajes++;

                    // Formatear Fecha (Soporta objetos Date de Excel o Strings)
                    let fechaStr = d.fecha;
                    if(d.fecha && d.fecha.seconds) { // Si es timestamp de Firestore
                        fechaStr = new Date(d.fecha.seconds * 1000).toLocaleDateString();
                    }

                    body.innerHTML += `
                        <tr>
                            <td>${fechaStr || '-'}</td>
                            <td>${d.obra || '-'}</td>
                            <td>${d.material || '-'}</td>
                            <td>${m3}</td>
                            <td>S/. ${d.precio || 0}</td>
                            <td>S/. ${d.transporte || 0}</td>
                            <td><strong>S/. ${precioTotal.toFixed(2)}</strong></td>
                            <td><span class="status ${d.estado ? d.estado.toLowerCase() : ''}">${d.estado || 'Pendiente'}</span></td>
                            <td>
                                <button class="btn btn-danger" onclick="deleteItem('Ventas', '${doc.id}')"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                });

                // ACTUALIZAR DASHBOARD (Corrección del bug de "Cargando...")
                document.getElementById('dashTotalVentas').innerText = `S/. ${totalSoles.toFixed(2)}`;
                document.getElementById('dashTotalM3').innerText = `${totalM3.toFixed(2)} m³`;
                document.getElementById('dashViajes').innerText = totalViajes;

            } catch (e) {
                console.error(e);
                body.innerHTML = '<tr><td colspan="9">Error al cargar datos.</td></tr>';
            }
        }

        async function loadStock() {
            const body = document.getElementById('bodyStock');
            const snap = await getDocs(collection(db, "Stock"));
            body.innerHTML = '';
            snap.forEach(doc => {
                const d = doc.data();
                const stock = parseFloat(d.stock) || 0;
                const status = stock > 10 ? 'Normal' : 'Bajo';
                const color = stock > 10 ? 'pagado' : 'cancelado';
                
                body.innerHTML += `
                    <tr>
                        <td>${d.material}</td>
                        <td>${stock}</td>
                        <td><span class="status ${color}">${status}</span></td>
                        <td>
                             <button class="btn btn-danger" onclick="deleteItem('Stock', '${doc.id}')"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });
        }

        async function loadPersonal() {
            const body = document.getElementById('bodyPersonal');
            const snap = await getDocs(collection(db, "Personal"));
            body.innerHTML = '';
            snap.forEach(doc => {
                const d = doc.data();
                body.innerHTML += `
                    <tr>
                        <td>${d.nombre || ''}</td>
                        <td>${d.cargo || ''}</td>
                        <td>${d.telefono || ''}</td>
                        <td>
                            <button class="btn btn-danger" onclick="deleteItem('Personal', '${doc.id}')"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });
        }

        // --- IMPORTACIÓN INTELIGENTE EXCEL (ExcelJS) ---
        // Detecta duplicados y usa tu estructura exacta
        document.getElementById('importVentas').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const workbook = new ExcelJS.Workbook();
            const reader = new FileReader();

            reader.onload = async (e) => {
                const buffer = e.target.result;
                await workbook.xlsx.load(buffer);
                const worksheet = workbook.getWorksheet(1); // Primera hoja

                // 1. Obtener datos existentes para evitar duplicados
                const snapshot = await getDocs(collection(db, "Ventas"));
                const existentes = [];
                snapshot.forEach(doc => {
                    const d = doc.data();
                    // Crear una "clave única" basada en datos: Fecha-Obra-Total
                    existentes.push(`${d.fecha}-${d.obra}-${d.total}`.toLowerCase().trim());
                });

                let nuevos = 0;
                let duplicados = 0;

                // 2. Recorrer Excel (Asumiendo fila 1 es encabezado, datos empiezan en fila 2)
                // Estructura: FECHA | OBRA | MATERIAL | M3 | PRECIO | TRANSPORTE | TOTAL | ESTADO
                worksheet.eachRow((row, rowNumber) => {
                    if (rowNumber > 1) { // Saltar encabezado
                        const rawDate = row.getCell(1).value; 
                        let fechaVal = rawDate;
                        
                        // Manejo de fechas de Excel
                        if(typeof rawDate === 'object') fechaVal = rawDate.toLocaleDateString();

                        const rowData = {
                            fecha: fechaVal,
                            obra: row.getCell(2).text,
                            material: row.getCell(3).text,
                            m3: row.getCell(4).value,
                            precio: row.getCell(5).value,
                            transporte: row.getCell(6).value,
                            total: row.getCell(7).value,
                            estado: row.getCell(8).text || 'Pendiente'
                        };

                        // Verificar validez (que tenga al menos obra y total)
                        if (rowData.obra && rowData.total) {
                            const clave = `${rowData.fecha}-${rowData.obra}-${rowData.total}`.toLowerCase().trim();
                            
                            if (!existentes.includes(clave)) {
                                addDoc(collection(db, "Ventas"), rowData);
                                nuevos++;
                            } else {
                                duplicados++;
                            }
                        }
                    }
                });

                alert(`Proceso terminado.\nNuevos agregados: ${nuevos}\nDuplicados ignorados: ${duplicados}`);
                loadVentas(); // Recargar tabla
            };
            reader.readAsArrayBuffer(file);
        });
        
        // Importar Personal (Lógica similar simple)
        document.getElementById('importPersonal').addEventListener('change', async (e) => {
             const file = e.target.files[0];
             if(!file) return;
             
             const workbook = new ExcelJS.Workbook();
             const reader = new FileReader();
             
             reader.onload = async (e) => {
                 await workbook.xlsx.load(e.target.result);
                 const ws = workbook.getWorksheet(1);
                 
                 // Buscar si existe columna "Nombre" o "Empleado"
                 // Implementación simple para Personal
                 ws.eachRow((row, rowNum) => {
                     if(rowNum > 1) {
                         const n = row.getCell(1).text; // Asume col 1 es nombre
                         if(n) {
                             addDoc(collection(db, "Personal"), {
                                 nombre: n,
                                 cargo: row.getCell(2).text,
                                 telefono: row.getCell(3).text
                             });
                         }
                     }
                 });
                 alert("Personal importado.");
                 loadPersonal();
             };
             reader.readAsArrayBuffer(file);
        });


        // --- EXPORTACIÓN PROFESIONAL EXCEL ---
        window.exportarExcelVentas = async () => {
            const workbook = new ExcelJS.Workbook();
            const sheet = workbook.addWorksheet('AGREGADOS VENTAS');

            // 1. Definir columnas y anchos (Estilo Profesional)
            sheet.columns = [
                { header: 'FECHA', key: 'fecha', width: 15 },
                { header: 'OBRA', key: 'obra', width: 30 },
                { header: 'MATERIAL', key: 'material', width: 20 },
                { header: 'M3', key: 'm3', width: 10 },
                { header: 'PRECIO', key: 'precio', width: 12 },
                { header: 'TRANSPORTE', key: 'transporte', width: 15 },
                { header: 'TOTAL', key: 'total', width: 15 },
                { header: 'ESTADO', key: 'estado', width: 15 }
            ];

            // 2. Estilo del Encabezado (Azul oscuro, texto blanco, negrita)
            const headerRow = sheet.getRow(1);
            headerRow.font = { bold: true, color: { argb: 'FFFFFFFF' } };
            headerRow.fill = {
                type: 'pattern',
                pattern: 'solid',
                fgColor: { argb: 'FF2C3E50' } // Tu color primary
            };
            headerRow.alignment = { vertical: 'middle', horizontal: 'center' };

            // 3. Agregar Datos de Firebase
            const snap = await getDocs(collection(db, "Ventas"));
            snap.forEach(doc => {
                const d = doc.data();
                const row = sheet.addRow(d);
                
                // Formato de moneda para columnas de dinero
                row.getCell('precio').numFmt = '"S/."#,##0.00';
                row.getCell('transporte').numFmt = '"S/."#,##0.00';
                row.getCell('total').numFmt = '"S/."#,##0.00';
                
                // Centrar celdas
                row.eachCell((cell) => {
                    cell.alignment = { vertical: 'middle', horizontal: 'left' };
                    cell.border = {
                        top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'}
                    };
                });
            });

            // 4. Descargar
            const buffer = await workbook.xlsx.writeBuffer();
            const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'Reporte_Ventas_Profesional.xlsx';
            link.click();
        };

        // --- SISTEMA DE MODALES Y CRUD ---
        window.openModal = (type, id=null) => {
            document.getElementById('genericModal').classList.add('active');
            currentModalType = type;
            const form = document.getElementById('dynamicForm');
            form.innerHTML = '';

            if(type === 'venta') {
                form.innerHTML = `
                    <input type="date" class="form-control" id="mFecha" required>
                    <input type="text" class="form-control" id="mObra" placeholder="Nombre de Obra / Cliente" required>
                    <input type="text" class="form-control" id="mMaterial" placeholder="Material (Arena, Piedra...)">
                    <input type="number" class="form-control" id="mM3" placeholder="Cantidad M3" step="0.01">
                    <input type="number" class="form-control" id="mPrecio" placeholder="Precio Material (S/.)" step="0.01">
                    <input type="number" class="form-control" id="mTrans" placeholder="Costo Transporte (S/.)" step="0.01">
                    <select class="form-control" id="mEstado">
                        <option value="Pendiente">Pendiente</option>
                        <option value="Pagado">Pagado</option>
                    </select>
                `;
            } else if(type === 'stock') {
                 form.innerHTML = `
                    <input type="text" class="form-control" id="sMat" placeholder="Nombre Material" required>
                    <input type="number" class="form-control" id="sStock" placeholder="Stock Actual (M3)">
                `;
            } else if(type === 'personal') {
                 form.innerHTML = `
                    <input type="text" class="form-control" id="pNom" placeholder="Nombre Completo" required>
                    <input type="text" class="form-control" id="pCargo" placeholder="Cargo">
                    <input type="text" class="form-control" id="pTel" placeholder="Teléfono">
                `;
            }
        };

        window.closeModal = () => document.getElementById('genericModal').classList.remove('active');

        document.getElementById('btnSave').onclick = async () => {
            const type = currentModalType;
            try {
                if(type === 'venta') {
                    const m3 = parseFloat(document.getElementById('mM3').value) || 0;
                    const pre = parseFloat(document.getElementById('mPrecio').value) || 0;
                    const tra = parseFloat(document.getElementById('mTrans').value) || 0;
                    
                    await addDoc(collection(db, "Ventas"), {
                        fecha: document.getElementById('mFecha').value,
                        obra: document.getElementById('mObra').value,
                        material: document.getElementById('mMaterial').value,
                        m3: m3,
                        precio: pre,
                        transporte: tra,
                        total: (m3 * pre) + tra, // Cálculo automático
                        estado: document.getElementById('mEstado').value
                    });
                } else if(type === 'stock') {
                     await addDoc(collection(db, "Stock"), {
                        material: document.getElementById('sMat').value,
                        stock: parseFloat(document.getElementById('sStock').value)
                    });
                } else if(type === 'personal') {
                     await addDoc(collection(db, "Personal"), {
                        nombre: document.getElementById('pNom').value,
                        cargo: document.getElementById('pCargo').value,
                        telefono: document.getElementById('pTel').value
                    });
                }
                closeModal();
                loadAllData();
                alert("Guardado correctamente");
            } catch(e) {
                alert("Error: " + e.message);
            }
        };

        window.deleteItem = async (coll, id) => {
            if(confirm("¿Eliminar registro?")) {
                await deleteDoc(doc(db, coll, id));
                loadAllData();
            }
        };

    </script>
</body>
</html>
