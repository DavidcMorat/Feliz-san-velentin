<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
 <h1>MerakiAPP</h1>

<style>
/* --- AMOLED STYLE --- */

@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@600;800&display=swap');

/* Fondo general */
body {
  background: #000;
  color: #fff;
  margin: 0;
  font-family: 'Poppins', sans-serif;
}

/* T√≠tulo */
.app-title {
  font-size: 2.2rem;
  text-align: center;
  margin: 20px 0 10px;
  background: linear-gradient(90deg, #00D4FF, #7F00FF);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  letter-spacing: 2px;
  animation: fadeIn 1s ease-in-out;
}

/* Tabs */
.tabs {
  display: flex;
  justify-content: space-around;
  background: #090909;
  border-bottom: 1px solid #111;
}

.tab {
  width: 33%;
  padding: 12px;
  text-align: center;
  cursor: pointer;
  font-size: 16px;
  color: #aaa;
  transition: background 0.3s, color 0.3s;
}

.tab.active {
  background: #111;
  color: #fff;
}

/* Vistas */
.view {
  display: none;
  padding: 20px;
  animation: fadeIn 0.4s ease;
}

.view.active {
  display: block;
}

/* Inputs */
input, textarea, select {
  width: 100%;
  margin-top: 12px;
  padding: 12px;
  border-radius: 12px;
  border: none;
  background: #0b0b0b;
  color: white;
  font-size: 16px;
  outline: none;
  border: 1px solid #1a1a1a;
}

/* Botones AMOLED */
button {
  width: 100%;
  padding: 14px;
  margin-top: 15px;
  border-radius: 14px;
  border: none;
  color: white;
  font-size: 16px;
  font-weight: 600;
  background: linear-gradient(135deg, #0000FF, #00FFFF);
  cursor: pointer;
  transition: transform 0.15s ease, opacity 0.2s;
}

/* ü§ç Glow blanco al presionar */
button:active {
  outline: none;
  box-shadow:
    0 0 12px rgba(255, 255, 255, 0.9),
    0 0 25px rgba(255, 255, 255, 0.8),
    0 0 40px rgba(255, 255, 255, 0.6);
  transform: scale(0.96);
}

/* ü§ç Glow suave al pasar el dedo encima (hover para t√°ctil tambi√©n) */
button:hover,
button:focus-visible {
  box-shadow:
    0 0 10px rgba(255, 255, 255, 0.7),
    0 0 20px rgba(255, 255, 255, 0.5);
  opacity: 0.95;
}

button:hover {
  transform: scale(1.05);
  opacity: 0.9;
}

/* Tarjetas para listas */
.item {
  background: #0b0b0b;
  border: 1px solid #1a1a1a;
  padding: 15px;
  border-radius: 16px;
  margin-top: 12px;
  font-size: 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  animation: fadeInUp 0.35s ease;
}

/* N√∫meros grandes */
.big-number {
  font-size: 2.4rem;
  font-weight: 800;
  text-align: center;
  margin-top: 10px;
  color: #00C6FF;
}

/* Animaciones */
@keyframes fadeIn {
  from { opacity: 0; }
  to   { opacity: 1; }
}

@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(10px); }
  to   { opacity: 1; transform: translateY(0); }
}

/* Quita el resaltado azul feo al tocar en Android/Chrome */
* {
  -webkit-tap-highlight-color: transparent;
}

/* Quita el borde cuando haces focus en los botones */
button:focus,
a:focus {
  outline: none !important;
  box-shadow: none !important;
}

.delete-btn {
  background: #111;
  border: 1px solid #333;
  color: #fff;
  font-size: 1.2rem;
  padding: 8px;
  width: 44px;
  height: 44px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s ease;
}

.delete-btn:hover {
  background: #1a1a1a;
  transform: scale(1.05);
}

.delete-btn:active {
  transform: scale(0.95);
}

</style>
</head>

<body>

<header>Gastos Meraki</header>

<div class="tabs">
  <div class="tab active" data-target="home">Inicio</div>
  <div class="tab" data-target="gastos">Gastos</div>
  <div class="tab" data-target="registro">Registro</div>
</div>

<!-- HOME -->
<div class="view active" id="home">
  <h2>Presupuesto actual</h2>

  <div class="big-number" id="totalPresupuesto">0</div>

  <p>Efectivo:</p>
  <div class="big-number" id="efectivoPresupuesto">0</div>

  <p>Yape:</p>
  <div class="big-number" id="yapePresupuesto">0</div>

  <h3>Agregar presupuesto</h3>

  <input type="number" id="montoAgregar" placeholder="Monto a agregar" />

  <select id="tipoMonto">
    <option value="efectivo">Efectivo</option>
    <option value="yape">Yape</option>
    <option value="general">General</option>
  </select>

  <textarea id="notaPresupuesto" placeholder="Nota (opcional al agregar)"></textarea>

  <button id="btnAgregarPresupuesto">Agregar</button>
  
  <button id="btnBorrarGastos">Borrar TODOS los gastos</button>
<button id="btnBorrarRegistro">Borrar TODO el registro</button>
<button id="btnResetPresupuesto">Restablecer presupuesto</button>

<button id="copiarResumenBtn" class="btn-amoled">üìã Copiar resumen</button>

</div>


<!-- GASTOS -->
<div class="view" id="gastos">
  <h2>Registrar gasto</h2>

  <input type="text" id="gastoNombre" placeholder="Nombre del producto" />
  <input type="number" id="gastoPrecio" placeholder="Precio" />

  <select id="metodoPago">
    <option value="efectivo">Efectivo</option>
    <option value="yape">Yape</option>
    <option value="general">General</option>
  </select>

  <button id="btnGuardarGasto">Guardar gasto</button>

  <h3>Gastos registrados</h3>
  <div id="listaGastos"></div>
</div>

<!-- REGISTRO -->
<div class="view" id="registro">
  <h2>Registro de eventos</h2>
  <div id="listaRegistro"></div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";

import {
  getFirestore, doc, getDoc, updateDoc, setDoc,
  addDoc, collection, deleteDoc, onSnapshot,
  getDocs, writeBatch
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
const firebaseConfig = {
  apiKey: "AIzaSyC495_-26LNEAISFd0uB-2wSDGZd-EY_Qc",
  authDomain: "datosmeraki-d4a4d.firebaseapp.com",
  projectId: "datosmeraki-d4a4d",
  storageBucket: "datosmeraki-d4a4d.firebasestorage.app",
  messagingSenderId: "813586255966",
  appId: "1:813586255966:web:78acf1f1cfa1f1b4a164cf",
  measurementId: "G-HXBGQGJCJE"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const presupuestoRef = doc(db, "Presupuesto", "actual");

/* ================= TABS (sin tocar) ================= */
document.querySelectorAll(".tab").forEach(tab => {
  tab.addEventListener("click", () => {
    document.querySelector(".tab.active").classList.remove("active");
    tab.classList.add("active");

    document.querySelector(".view.active").classList.remove("active");
    document.getElementById(tab.dataset.target).classList.add("active");
  });
});

/* ================ asegurar doc presupuesto ================ */
async function ensurePresupuesto() {
  const snap = await getDoc(presupuestoRef);
  if (!snap.exists()) {
    await setDoc(presupuestoRef, {
      total: 0,
      efectivo: 0,
      yape: 0,
      notas: ""
    });
  }
}
ensurePresupuesto();

/* ================ PRESUPUESTO en vivo ================ */
onSnapshot(presupuestoRef, snap => {
  if (!snap.exists()) return;
  const d = snap.data();
  document.getElementById("totalPresupuesto").textContent = d.total ?? 0;
  document.getElementById("efectivoPresupuesto").textContent = d.efectivo ?? 0;
  document.getElementById("yapePresupuesto").textContent = d.yape ?? 0;
});

/* ================ AGREGAR PRESUPUESTO (extra) ================ */
document.getElementById("btnAgregarPresupuesto").addEventListener("click", async () => {
  const monto = Number(document.getElementById("montoAgregar").value);
  const tipo = document.getElementById("tipoMonto").value;
  const nota = document.getElementById("notaPresupuesto").value || "";

  if (!monto || monto <= 0) return alert("Monto inv√°lido bro");

  const snap = await getDoc(presupuestoRef);
  const data = snap.data();

  const nuevoTotal = (data.total || 0) + monto;
  let nuevoEfectivo = data.efectivo || 0;
  let nuevoYape = data.yape || 0;

  if (tipo === "efectivo") nuevoEfectivo += monto;
  else if (tipo === "yape") nuevoYape += monto;

  await updateDoc(presupuestoRef, {
    total: nuevoTotal,
    efectivo: nuevoEfectivo,
    yape: nuevoYape,
    notas: nota
  });

  // registro solo al agregar presupuesto (como quer√≠as)
  await addDoc(collection(db, "Registro"), {
    mensaje: `Agregaste S/ ${monto} a ${tipo}`,
    fecha: new Date()
  });

  // limpiar inputs
  document.getElementById("montoAgregar").value = "";
  document.getElementById("notaPresupuesto").value = "";
});

/* ================ GUARDAR GASTO (AHORA RESTA PRESUPUESTO) ================ */
document.getElementById("btnGuardarGasto").addEventListener("click", async () => {
  const nombre = document.getElementById("gastoNombre").value.trim();
  const precio = Number(document.getElementById("gastoPrecio").value);
  const metodo = document.getElementById("metodoPago").value;

  if (!nombre || !precio || precio <= 0) return alert("Bro llena todo bien");

  // obtener presupuesto actual
  const snap = await getDoc(presupuestoRef);
  if (!snap.exists()) return alert("Presupuesto no existe");

  const data = snap.data();
  const saldoMetodo = (metodo === "efectivo") ? (data.efectivo || 0)
                    : (metodo === "yape") ? (data.yape || 0)
                    : (data.total || 0); // general usa total si quieres

  // si quieres bloquear gasto si no hay saldo suficiente:
  if (saldoMetodo < precio) {
    return alert(`No hay suficiente ${metodo}. Saldo: S/ ${saldoMetodo}`);
  }

  // 1) Guardar gasto
  const gastoRef = await addDoc(collection(db, "Gastos"), {
    nombre,
    precio,
    metodo,
    fecha: new Date()
  });

  // 2) Actualizar presupuesto restando el precio
  const nuevoTotal = (data.total || 0) - precio;
  let nuevoEfectivo = data.efectivo || 0;
  let nuevoYape = data.yape || 0;

  if (metodo === "efectivo") nuevoEfectivo -= precio;
  else if (metodo === "yape") nuevoYape -= precio;

  await updateDoc(presupuestoRef, {
    total: nuevoTotal,
    efectivo: nuevoEfectivo,
    yape: nuevoYape
  });

  // 3) Opcional: agregar registro del gasto
  await addDoc(collection(db, "Registro"), {
    mensaje: `Gastaste S/ ${precio} en ${nombre} (${metodo})`,
    fecha: new Date()
  });

  // limpiar inputs
  document.getElementById("gastoNombre").value = "";
  document.getElementById("gastoPrecio").value = "";
});

/* ================ LISTA GASTOS EN VIVO (y borrar devuelve dinero) ================ */
onSnapshot(collection(db, "Gastos"), snap => {
  const cont = document.getElementById("listaGastos");
  cont.innerHTML = "";

  snap.forEach(docu => {
    const d = docu.data();
    const id = docu.id;

    const box = document.createElement("div");
    box.className = "item";
    box.innerHTML = `
      <span>${d.nombre} ‚Äî S/ ${d.precio}</span>
      <button class="delete-btn" data-id="${doc.id}">üóëÔ∏è</button>
    `;
    cont.appendChild(box);
  });

  // attach listeners (re-attach safe)
  document.querySelectorAll(".delGasto").forEach(btn => {
    btn.onclick = async () => {
      const id = btn.dataset.id;
      // obtener documento gasto para conocer precio y metodo
      const gastoSnap = await getDoc(doc(db, "Gastos", id));
      if (!gastoSnap.exists()) {
        // si no existe, borrar igual
        await deleteDoc(doc(db, "Gastos", id));
        return;
      }
      const gasto = gastoSnap.data();
      const precio = Number(gasto.precio || 0);
      const metodo = gasto.metodo;

      // 1) eliminar el gasto
      await deleteDoc(doc(db, "Gastos", id));

      // 2) devolver dinero al presupuesto (sumar)
      const presSnap = await getDoc(presupuestoRef);
      if (!presSnap.exists()) return;
      const p = presSnap.data();

      const nuevoTotal = (p.total || 0) + precio;
      let nuevoEfectivo = p.efectivo || 0;
      let nuevoYape = p.yape || 0;

      if (metodo === "efectivo") nuevoEfectivo += precio;
      else if (metodo === "yape") nuevoYape += precio;

      await updateDoc(presupuestoRef, {
        total: nuevoTotal,
        efectivo: nuevoEfectivo,
        yape: nuevoYape
      });

      // 3) registrar evento
      await addDoc(collection(db, "Registro"), {
        mensaje: `Eliminaste gasto ${gasto.nombre}, se devolvieron S/ ${precio} a ${metodo}`,
        fecha: new Date()
         });
    };
  });
});

/* ================ LISTA REGISTRO EN VIVO ================ */
onSnapshot(collection(db, "Registro"), snap => {
  const cont = document.getElementById("listaRegistro");
  cont.innerHTML = "";

  snap.forEach(docu => {
    const d = docu.data();
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `<span>${d.mensaje || "sin mensaje"}</span>`;
    cont.appendChild(div);
  });
});

document.getElementById("btnBorrarGastos").addEventListener("click", async () => {
  if (!confirm("¬øestas seguro? Esto borra TODOS los gastos.")) return;

  const ref = collection(db, "Gastos");
  const snap = await getDocs(ref);

  const batch = writeBatch(db);
  snap.forEach(docu => batch.delete(docu.ref));
  await batch.commit();

  await addDoc(collection(db, "Registro"), {
    mensaje: "Se borraron todos los gastos",
    fecha: new Date()
  });
});

document.getElementById("btnBorrarRegistro").addEventListener("click", async () => {
  if (!confirm("¬øSeguro? esto borra TODO el registro.")) return;

  const ref = collection(db, "Registro");
  const snap = await getDocs(ref);

  const batch = writeBatch(db);
  snap.forEach(docu => batch.delete(docu.ref));
  await batch.commit();
});

document.getElementById("btnResetPresupuesto").addEventListener("click", async () => {
  if (!confirm("¬øDeseas restablecer el presupuesto completo?")) return;

  await updateDoc(presupuestoRef, {
    total: 0,
    efectivo: 0,
    yape: 0,
    notas: ""
  });

  await addDoc(collection(db, "Registro"), {
    mensaje: "Presupuesto restablecido",
    fecha: new Date()
  });

  cargarPresupuesto();
});

// COPIAR RESUMEN (DEL MES)
document.getElementById("copiarResumenBtn").addEventListener("click", async () => {
  try {
    const month = new Date().getMonth() + 1;
    const year = new Date().getFullYear();

    const q = await getDocs(collection(db, "gastos"));
    let total = 0;
    let lista = "";

    q.forEach(doc => {
      const data = doc.data();
      const fecha = new Date(data.fecha);

      if (fecha.getMonth() + 1 === month && fecha.getFullYear() === year) {
        total += parseFloat(data.monto || 0);
        lista += `‚Ä¢ ${data.producto}: S/ ${data.monto}\n`;
      }
    });

    const resumen = 
`üìÖ Resumen de ${month}/${year}
Total gastado: S/ ${total.toFixed(2)}

Productos:
${lista}`;

    await navigator.clipboard.writeText(resumen);
    alert("Resumen copiado üü¶‚ú®");
  } catch (e) {
    alert("Uff bro algo fall√≥ üò≠");
    console.error(e);
  }
});
</script>
  

</body>
</html>
